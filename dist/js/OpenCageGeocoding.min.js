/**
 * OpenCage Data Geocoding Control v3.0.0-alpha.1 - 2025-10-13
 * Copyright (c) 2025, OpenCage GmbH 
 * support@opencagedata.com 
 * https://opencagedata.com 
 * 
 * Licensed under the BSD license. 
 * Demo: https://opencagedata.com/tutorials/geocode-in-leaflet
 * Source: git@github.com:opencagedata/leaflet-opencage-geocoding.git 
 */
(function(a,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("leaflet")):typeof define=="function"&&define.amd?define(["exports","leaflet"],i):(a=typeof globalThis<"u"?globalThis:a||self,i(a["leaflet-control-opencage-geocoding"]={},a.L))})(this,(function(a,i){"use strict";class f extends Error{response;status;constructor(e){super(e),this.name="GeocodeError"}}const E="OpenCageData Geocoding NodeJS API Client/2.0.1";function k(s){if(s.status>=200&&s.status<300)return s;const e=s.statusText||`HTTP error ${s.status}`,o=new f(e);throw o.status={code:s.status,message:e},o.response=s,o}function C(s){return s.json()}async function R(s,e,o,t){fetch(s,{method:"GET",headers:{"User-Agent":E,"Content-Type":"application/json",Accept:"application/json"},signal:t}).then(k).then(C).then(n=>{e(n)}).catch(n=>{o(n)})}const b="https://api.opencagedata.com/geocode/v1/json";function _(s,e){const o=new f(e),t={code:s,message:e};return o.status=t,o.response={status:t},o}function u(s){return s===void 0||s===""}function m(s){return s==null}function x(s){return m(s)?"":Object.keys(s).map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(s[e]||"")}`).join("&")}function G(s,e){const o={...s};let t=b,n=!1;return u(s.proxyURL)&&u(e?.proxyURL)?(u(s.key)&&typeof process<"u"&&(o.key=process.env.OPENCAGE_API_KEY),u(o.key)&&(n=!0)):(t=e?.proxyURL,u(t)&&(t=s.proxyURL),delete o.proxyURL),{missingKey:n,endpoint:t,query:o}}const O="missing or bad query",S="missing API key";async function U(s,e){return new Promise((o,t)=>{if(m(s)){const d=_(400,O);t(d);return}const n=G(s,e);if(n.missingKey){const d=_(401,S);t(d);return}const{query:r,endpoint:l}=n,c=x(r),g=`${l}?${c}`;R(g,o,t,e?.signal)})}class p{constructor(e={}){this.options={geocodingQueryParams:{},key:"",limit:5,...e}}geocode(e,o,t){const n=this._getProximity(t),r={q:e,limit:this.options.limit,key:this.options.key,...n,...this.options.geocodingQueryParams};this._makeRequest(r,l=>{const c=this._processResults(l);o.call(t,c)})}reverse(e,o,t,n){this.geocode(e,t,n)}_getProximity(e){const o={};if(e&&e._map&&e._map.getCenter()){const t=e._map.getCenter();o.proximity=t.lat+","+t.lng}return o}_processResults(e){const o=[];for(let t=e.results.length-1;t>=0;t--)o[t]={name:e.results[t].formatted,center:new i.LatLng(e.results[t].geometry.lat,e.results[t].geometry.lng)},e.results[t].bounds&&(o[t].bounds=new i.LatLngBounds([e.results[t].bounds.southwest.lat,e.results[t].bounds.southwest.lng],[e.results[t].bounds.northeast.lat,e.results[t].bounds.northeast.lng])),this.options.resultExtension&&this._addResultExtensions(o[t],e.results[t]);return o}_addResultExtensions(e,o){const t=this.options.resultExtension,n=Object.keys(t);for(let r=n.length-1;r>=0;r--){const l=n[r];let c=o;const g=t[l].split(".");for(let d=0;d<g.length;d++){const v=g[d];if(c[v])c=c[v];else{c=void 0;break}}e[l]=c}}_makeRequest(e,o){U(e).then(t=>{o(t)})}}class h extends i.Control{constructor(e={}){super(e),this.options={showResultIcons:!1,collapsed:!0,expand:"click",position:"topright",placeholder:"Search...",errorMessage:"Nothing found.",key:"",onResultClick:void 0,addResultToMap:!0,limit:5,...e},this._callbackId=0,this.options.geocoder||(this.options.geocoder=new p(this.options))}onAdd(e){const o="leaflet-control-opencage-geocoding",t=i.DomUtil.create("div",o),n=i.DomUtil.create("div","leaflet-control-opencage-geocoding-icon",t),r=i.DomUtil.create("form",o+"-form",t);this._form=r,this._map=e,this._container=t;const l=i.DomUtil.create("input");return this._input=l,l.type="text",l.placeholder=this.options.placeholder,l.addEventListener("keydown",this._keydown.bind(this)),this._errorElement=document.createElement("div"),this._errorElement.className=o+"-form-no-error",this._errorElement.innerHTML=this.options.errorMessage,this._alts=i.DomUtil.create("ul",o+"-alternatives leaflet-control-opencage-geocoding-alternatives-minimized"),r.appendChild(l),r.appendChild(this._errorElement),t.appendChild(this._alts),r.addEventListener("submit",this._geocode.bind(this)),this.options.collapsed?this.options.expand==="click"?n.addEventListener("click",c=>{c.button===0&&c.detail!==2&&this._toggle()}):(n.addEventListener("mouseover",this._expand.bind(this)),n.addEventListener("mouseout",this._collapse.bind(this)),this._map.on("movestart",this._collapse,this)):this._expand(),i.DomEvent.disableClickPropagation(t),t}_geocodeResult(e){if(this._container.classList.remove("leaflet-control-opencage-geocoding-spinner"),e.length===1)this._geocodeResultSelected(e[0]);else if(e.length>0){this._alts.innerHTML="",this._results=e,this._alts.classList.remove("leaflet-control-opencage-geocoding-alternatives-minimized");for(let o=0;o<e.length;o++)this._alts.appendChild(this._createAlt(e[o],o))}else this._errorElement.classList.add("leaflet-control-opencage-geocoding-error")}markGeocode(e){return e.bounds?this._map.fitBounds(e.bounds):this._map.panTo(e.center),this._geocodeMarker&&this._map.removeLayer(this._geocodeMarker),this._geocodeMarker=new i.Marker(e.center).bindPopup(e.name).addTo(this._map).openPopup(),this}_geocode(e){return i.DomEvent.preventDefault(e),this._container.classList.add("leaflet-control-opencage-geocoding-spinner"),this._clearResults(),this.options.geocoder.geocode(this._input.value,this._geocodeResult,this),!1}_geocodeResultSelected(e){this.options.collapsed?this._collapse():this._clearResults(),this.options.onResultClick&&typeof this.options.onResultClick=="function"&&this.options.onResultClick(e),this.options.addResultToMap&&this.markGeocode(e)}_toggle(){this._container.className.indexOf("leaflet-control-opencage-geocoding-expanded")>=0?this._collapse():this._expand()}_expand(){this._container.classList.add("leaflet-control-opencage-geocoding-expanded"),this._input.select()}_collapse(){this._container.className=this._container.className.replace(" leaflet-control-opencage-geocoding-expanded",""),this._alts.classList.add("leaflet-control-opencage-geocoding-alternatives-minimized"),this._errorElement.classList.remove("leaflet-control-opencage-geocoding-error")}_clearResults(){this._alts.classList.add("leaflet-control-opencage-geocoding-alternatives-minimized"),this._selection=null,this._errorElement.classList.remove("leaflet-control-opencage-geocoding-error")}_createAlt(e,o){const t=document.createElement("li");return t.innerHTML='<a href="#" data-result-index="'+o+'">'+(this.options.showResultIcons&&e.icon?'<img src="'+e.icon+'"/>':"")+e.name+"</a>",t.addEventListener("click",()=>{this._geocodeResultSelected(e)}),t}_keydown(e){const o=t=>{this._selection&&(this._selection.firstChild.classList.remove("leaflet-control-opencage-geocoding-selected"),this._selection=this._selection[t>0?"nextSibling":"previousSibling"]),this._selection||(this._selection=this._alts[t>0?"firstChild":"lastChild"]),this._selection&&this._selection.firstChild.classList.add("leaflet-control-opencage-geocoding-selected")};switch(e.keyCode){case 38:o(-1),i.DomEvent.preventDefault(e);break;case 40:o(1),i.DomEvent.preventDefault(e);break;case 13:if(this._selection){const t=parseInt(this._selection.firstChild.getAttribute("data-result-index"),10);this._geocodeResultSelected(this._results[t]),this._clearResults(),i.DomEvent.preventDefault(e)}break}return!0}}const w=h,y=s=>new h(s);h.Geocoder=p,h.geocoder=s=>new p(s),Object.assign(L.Control,{OpenCageGeocoding:h,openCageGeocoding:y}),a.OpenCageGeocoder=p,a.OpenCageGeocoding=w,a.default=h,a.openCageGeocoding=y,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
