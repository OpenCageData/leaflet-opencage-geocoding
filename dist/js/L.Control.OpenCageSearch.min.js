/* 
 * OpenCage Data Search Control v1.4.1 - 2021-01-09
 * Copyright (c) 2021, OpenCage GmbH 
 * support@opencagedata.com 
 * https://opencagedata.com 
 * 
 * Licensed under the BSD license. 
 * Demo: https://opencagedata.com 
 * Source: git@github.com:opencagedata/leaflet-opencage-search.git 
 */

!function(e){var t;if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("undefined"!=typeof module)t=require("leaflet"),module.exports=e(t);else{if(void 0===window.L)throw"Leaflet must be loaded first";e(window.L)}}(function(p){"use strict";return p.Control.OpenCageSearch=p.Control.extend({options:{showResultIcons:!1,collapsed:!0,expand:"click",position:"topright",placeholder:"Search...",errorMessage:"Nothing found.",key:"",onResultClick:void 0,addResultToMap:!0,limit:5},_callbackId:0,initialize:function(e){p.Util.setOptions(this,e),this.options.geocoder||(this.options.geocoder=new p.Control.OpenCageSearch.Geocoder(this.options))},onAdd:function(e){var t="leaflet-control-ocd-search",o=p.DomUtil.create("div",t),s=p.DomUtil.create("div","leaflet-control-ocd-search-icon",o),n=this._form=p.DomUtil.create("form",t+"-form",o);return this._map=e,this._container=o,(e=this._input=p.DomUtil.create("input")).type="text",e.placeholder=this.options.placeholder,p.DomEvent.addListener(e,"keydown",this._keydown,this),this._errorElement=document.createElement("div"),this._errorElement.className=t+"-form-no-error",this._errorElement.innerHTML=this.options.errorMessage,this._alts=p.DomUtil.create("ul",t+"-alternatives leaflet-control-ocd-search-alternatives-minimized"),n.appendChild(e),n.appendChild(this._errorElement),o.appendChild(this._alts),p.DomEvent.addListener(n,"submit",this._geocode,this),this.options.collapsed?"click"===this.options.expand?p.DomEvent.addListener(s,"click",function(e){0===e.button&&2!==e.detail&&this._toggle()},this):(p.DomEvent.addListener(s,"mouseover",this._expand,this),p.DomEvent.addListener(s,"mouseout",this._collapse,this),this._map.on("movestart",this._collapse,this)):this._expand(),p.DomEvent.disableClickPropagation(o),o},_geocodeResult:function(e){if(p.DomUtil.removeClass(this._container,"leaflet-control-ocd-search-spinner"),1===e.length)this._geocodeResultSelected(e[0]);else if(0<e.length){this._alts.innerHTML="",this._results=e,p.DomUtil.removeClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized");for(var t=0;t<e.length;t++)this._alts.appendChild(this._createAlt(e[t],t))}else p.DomUtil.addClass(this._errorElement,"leaflet-control-ocd-search-error")},markGeocode:function(e){return e.bounds?this._map.fitBounds(e.bounds):this._map.panTo(e.center),this._geocodeMarker&&this._map.removeLayer(this._geocodeMarker),this._geocodeMarker=new p.Marker(e.center).bindPopup(e.name).addTo(this._map).openPopup(),this},_geocode:function(e){return p.DomEvent.preventDefault(e),p.DomUtil.addClass(this._container,"leaflet-control-ocd-search-spinner"),this._clearResults(),this.options.geocoder.geocode(this._input.value,this._geocodeResult,this),!1},_geocodeResultSelected:function(e){this.options.collapsed?this._collapse():this._clearResults(),this.options.onResultClick&&"function"==typeof this.options.onResultClick&&this.options.onResultClick(e),this.options.addResultToMap&&this.markGeocode(e)},_toggle:function(){0<=this._container.className.indexOf("leaflet-control-ocd-search-expanded")?this._collapse():this._expand()},_expand:function(){p.DomUtil.addClass(this._container,"leaflet-control-ocd-search-expanded"),this._input.select()},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-ocd-search-expanded",""),p.DomUtil.addClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized"),p.DomUtil.removeClass(this._errorElement,"leaflet-control-ocd-search-error")},_clearResults:function(){p.DomUtil.addClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized"),this._selection=null,p.DomUtil.removeClass(this._errorElement,"leaflet-control-ocd-search-error")},_createAlt:function(e,t){var o=document.createElement("li");return o.innerHTML='<a href="#" data-result-index="'+t+'">'+(this.options.showResultIcons&&e.icon?'<img src="'+e.icon+'"/>':"")+e.name+"</a>",p.DomEvent.addListener(o,"click",function(){this._geocodeResultSelected(e)},this),o},_keydown:function(e){function t(e){s._selection&&(p.DomUtil.removeClass(s._selection.firstChild,"leaflet-control-ocd-search-selected"),s._selection=s._selection[0<e?"nextSibling":"previousSibling"]),s._selection||(s._selection=s._alts[0<e?"firstChild":"lastChild"]),s._selection&&p.DomUtil.addClass(s._selection.firstChild,"leaflet-control-ocd-search-selected")}var o,s=this;switch(e.keyCode){case 38:t(-1),p.DomEvent.preventDefault(e);break;case 40:t(1),p.DomEvent.preventDefault(e);break;case 13:this._selection&&(o=parseInt(this._selection.firstChild.getAttribute("data-result-index"),10),this._geocodeResultSelected(this._results[o]),this._clearResults(),p.DomEvent.preventDefault(e))}return!0}}),p.Control.openCageSearch=function(e,t){return new p.Control.OpenCageSearch(e,t)},p.Control.OpenCageSearch.callbackId=0,p.Control.OpenCageSearch.jsonp=function(e,t,o,s,n){var i="_ocd_geocoder_"+p.Control.OpenCageSearch.callbackId++;t[n||"callback"]=i,window[i]=p.Util.bind(o,s);s=document.createElement("script");s.type="text/javascript",s.src=e+p.Util.getParamString(t),s.id=i,s.addEventListener("error",function(){o({results:[]})}),s.addEventListener("abort",function(){o({results:[]})}),document.getElementsByTagName("head")[0].appendChild(s)},p.Control.OpenCageSearch.Geocoder=p.Class.extend({options:{serviceUrl:"https://api.opencagedata.com/geocode/v1/",geocodingQueryParams:{},reverseQueryParams:{},key:"",limit:5},initialize:function(e){p.Util.setOptions(this,e)},geocode:function(e,h,u){var t,o={};u&&u._map&&u._map.getCenter()&&(t=u._map.getCenter(),o.proximity=t.lat+","+t.lng),p.Control.OpenCageSearch.jsonp(this.options.serviceUrl+"json/",p.extend({q:e,limit:this.options.limit,key:this.options.key},o,this.options.geocodingQueryParams),function(e){for(var t=[],o=e.results.length-1;0<=o;o--)if(t[o]={name:e.results[o].formatted,center:p.latLng(e.results[o].geometry.lat,e.results[o].geometry.lng)},e.results[o].bounds&&(t[o].bounds=p.latLngBounds([e.results[o].bounds.southwest.lat,e.results[o].bounds.southwest.lng],[e.results[o].bounds.northeast.lat,e.results[o].bounds.northeast.lng])),this.options.resultExtension)for(var s=this.options.resultExtension,n=Object.keys(s),i=n.length-1;0<=i;i--){for(var l=n[i],r=e.results[o],a=s[l].split("."),c=0;c<a.length;c++)var d=a[c],r=r[d]||void 0;t[o][l]=r}h.call(u,t)},this,"jsonp")},reverse:function(e,t,o,s){this.geocode(e,o,s)}}),p.Control.OpenCageSearch.geocoder=function(e){return new p.Control.OpenCageSearch.Geocoder(e)},p.Control.OpenCageSearch});