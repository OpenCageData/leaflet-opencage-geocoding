/**
 * OpenCage Data Geocoding Control v3.0.0-alpha.2 - 2025-10-14
 * Copyright (c) 2025, OpenCage GmbH 
 * support@opencagedata.com 
 * https://opencagedata.com 
 * 
 * Licensed under the BSD license. 
 * Demo: https://opencagedata.com/tutorials/geocode-in-leaflet
 * Source: git@github.com:opencagedata/leaflet-opencage-geocoding.git 
 */
(function(i,s){typeof exports=="object"&&typeof module<"u"?s(exports,require("leaflet"),require("opencage-api-client")):typeof define=="function"&&define.amd?define(["exports","leaflet","opencage-api-client"],s):(i=typeof globalThis<"u"?globalThis:i||self,s(i["leaflet-control-opencage-geocoding"]={},i.L,i.opencageApiClient))})(this,(function(i,s,m){"use strict";class h{constructor(e={}){this.options={geocodingQueryParams:{},key:"",limit:5,...e}}geocode(e,o,t){const n=this._getProximity(t),l={q:e,limit:this.options.limit,key:this.options.key,...n,...this.options.geocodingQueryParams};this._makeRequest(l,c=>{const r=this._processResults(c);o.call(t,r)})}reverse(e,o,t,n){this.geocode(e,t,n)}_getProximity(e){const o={};if(e&&e._map&&e._map.getCenter()){const t=e._map.getCenter();o.proximity=t.lat+","+t.lng}return o}_processResults(e){const o=[];for(let t=e.results.length-1;t>=0;t--)o[t]={name:e.results[t].formatted,center:new s.LatLng(e.results[t].geometry.lat,e.results[t].geometry.lng)},e.results[t].bounds&&(o[t].bounds=new s.LatLngBounds([e.results[t].bounds.southwest.lat,e.results[t].bounds.southwest.lng],[e.results[t].bounds.northeast.lat,e.results[t].bounds.northeast.lng])),this.options.resultExtension&&this._addResultExtensions(o[t],e.results[t]);return o}_addResultExtensions(e,o){const t=this.options.resultExtension,n=Object.keys(t);for(let l=n.length-1;l>=0;l--){const c=n[l];let r=o;const u=t[c].split(".");for(let p=0;p<u.length;p++){const _=u[p];if(r[_])r=r[_];else{r=void 0;break}}e[c]=r}}_makeRequest(e,o){m.geocode(e).then(t=>{o(t)})}}class a extends s.Control{constructor(e={}){super(e),this.options={showResultIcons:!1,collapsed:!0,expand:"click",position:"topright",placeholder:"Search...",errorMessage:"Nothing found.",key:"",onResultClick:void 0,addResultToMap:!0,limit:5,...e},this._callbackId=0,this.options.geocoder||(this.options.geocoder=new h(this.options))}onAdd(e){const o="leaflet-control-opencage-geocoding",t=s.DomUtil.create("div",o),n=s.DomUtil.create("div","leaflet-control-opencage-geocoding-icon",t),l=s.DomUtil.create("form",o+"-form",t);this._form=l,this._map=e,this._container=t;const c=s.DomUtil.create("input");return this._input=c,c.type="text",c.placeholder=this.options.placeholder,c.addEventListener("keydown",this._keydown.bind(this)),this._errorElement=document.createElement("div"),this._errorElement.className=o+"-form-no-error",this._errorElement.innerHTML=this.options.errorMessage,this._alts=s.DomUtil.create("ul",o+"-alternatives leaflet-control-opencage-geocoding-alternatives-minimized"),l.appendChild(c),l.appendChild(this._errorElement),t.appendChild(this._alts),l.addEventListener("submit",this._geocode.bind(this)),this.options.collapsed?this.options.expand==="click"?n.addEventListener("click",r=>{r.button===0&&r.detail!==2&&this._toggle()}):(n.addEventListener("mouseover",this._expand.bind(this)),n.addEventListener("mouseout",this._collapse.bind(this)),this._map.on("movestart",this._collapse,this)):this._expand(),s.DomEvent.disableClickPropagation(t),t}_geocodeResult(e){if(this._container.classList.remove("leaflet-control-opencage-geocoding-spinner"),e.length===1)this._geocodeResultSelected(e[0]);else if(e.length>0){this._alts.innerHTML="",this._results=e,this._alts.classList.remove("leaflet-control-opencage-geocoding-alternatives-minimized");for(let o=0;o<e.length;o++)this._alts.appendChild(this._createAlt(e[o],o))}else this._errorElement.classList.add("leaflet-control-opencage-geocoding-error")}markGeocode(e){return e.bounds?this._map.fitBounds(e.bounds):this._map.panTo(e.center),this._geocodeMarker&&this._map.removeLayer(this._geocodeMarker),this._geocodeMarker=new s.Marker(e.center).bindPopup(e.name).addTo(this._map).openPopup(),this}_geocode(e){return s.DomEvent.preventDefault(e),this._container.classList.add("leaflet-control-opencage-geocoding-spinner"),this._clearResults(),this.options.geocoder.geocode(this._input.value,this._geocodeResult,this),!1}_geocodeResultSelected(e){this.options.collapsed?this._collapse():this._clearResults(),this.options.onResultClick&&typeof this.options.onResultClick=="function"&&this.options.onResultClick(e),this.options.addResultToMap&&this.markGeocode(e)}_toggle(){this._container.className.indexOf("leaflet-control-opencage-geocoding-expanded")>=0?this._collapse():this._expand()}_expand(){this._container.classList.add("leaflet-control-opencage-geocoding-expanded"),this._input.select()}_collapse(){this._container.className=this._container.className.replace(" leaflet-control-opencage-geocoding-expanded",""),this._alts.classList.add("leaflet-control-opencage-geocoding-alternatives-minimized"),this._errorElement.classList.remove("leaflet-control-opencage-geocoding-error")}_clearResults(){this._alts.classList.add("leaflet-control-opencage-geocoding-alternatives-minimized"),this._selection=null,this._errorElement.classList.remove("leaflet-control-opencage-geocoding-error")}_createAlt(e,o){const t=document.createElement("li");return t.innerHTML='<a href="#" data-result-index="'+o+'">'+(this.options.showResultIcons&&e.icon?'<img src="'+e.icon+'"/>':"")+e.name+"</a>",t.addEventListener("click",()=>{this._geocodeResultSelected(e)}),t}_keydown(e){const o=t=>{this._selection&&(this._selection.firstChild.classList.remove("leaflet-control-opencage-geocoding-selected"),this._selection=this._selection[t>0?"nextSibling":"previousSibling"]),this._selection||(this._selection=this._alts[t>0?"firstChild":"lastChild"]),this._selection&&this._selection.firstChild.classList.add("leaflet-control-opencage-geocoding-selected")};switch(e.keyCode){case 38:o(-1),s.DomEvent.preventDefault(e);break;case 40:o(1),s.DomEvent.preventDefault(e);break;case 13:if(this._selection){const t=parseInt(this._selection.firstChild.getAttribute("data-result-index"),10);this._geocodeResultSelected(this._results[t]),this._clearResults(),s.DomEvent.preventDefault(e)}break}return!0}}const f=a,g=d=>new a(d);a.Geocoder=h,a.geocoder=d=>new h(d),Object.assign(L.Control,{OpenCageGeocoding:a,openCageGeocoding:g}),i.OpenCageGeocoder=h,i.OpenCageGeocoding=f,i.default=a,i.openCageGeocoding=g,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
