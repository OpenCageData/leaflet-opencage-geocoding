/**
 * OpenCage Data Geocoding Control v3.0.0-alpha.1 - 2025-10-07
 * Copyright (c) 2025, OpenCage GmbH 
 * support@opencagedata.com 
 * https://opencagedata.com 
 * 
 * Licensed under the BSD license. 
 * Demo: https://opencagedata.com 
 * Source: git@github.com:opencagedata/leaflet-opencage-geocoding.git 
 */
(function(a,n){typeof exports=="object"&&typeof module<"u"?n(exports,require("leaflet")):typeof define=="function"&&define.amd?define(["exports","leaflet"],n):(a=typeof globalThis<"u"?globalThis:a||self,n(a["leaflet-control-opencage-geocoding"]={},a.L))})(this,(function(a,n){"use strict";class m extends Error{response;status;constructor(e){super(e),this.name="GeocodeError"}}const v="OpenCageData Geocoding NodeJS API Client/2.0.1";function E(s){if(s.status>=200&&s.status<300)return s;const e=s.statusText||`HTTP error ${s.status}`,o=new m(e);throw o.status={code:s.status,message:e},o.response=s,o}function k(s){return s.json()}async function R(s,e,o,t){fetch(s,{method:"GET",headers:{"User-Agent":v,"Content-Type":"application/json",Accept:"application/json"},signal:t}).then(E).then(k).then(i=>{e(i)}).catch(i=>{o(i)})}const b="https://api.opencagedata.com/geocode/v1/json";function f(s,e){const o=new m(e),t={code:s,message:e};return o.status=t,o.response={status:t},o}function u(s){return s===void 0||s===""}function _(s){return s==null}function U(s){return _(s)?"":Object.keys(s).map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(s[e]||"")}`).join("&")}function x(s,e){const o={...s};let t=b,i=!1;return u(s.proxyURL)&&u(e?.proxyURL)?(u(s.key)&&typeof process<"u"&&(o.key=process.env.OPENCAGE_API_KEY),u(o.key)&&(i=!0)):(t=e?.proxyURL,u(t)&&(t=s.proxyURL),delete o.proxyURL),{missingKey:i,endpoint:t,query:o}}const D="missing or bad query",G="missing API key";async function O(s,e){return new Promise((o,t)=>{if(_(s)){const d=f(400,D);t(d);return}const i=x(s,e);if(i.missingKey){const d=f(401,G);t(d);return}const{query:l,endpoint:r}=i,c=U(l),g=`${r}?${c}`;R(g,o,t,e?.signal)})}class p{constructor(e={}){this.options={geocodingQueryParams:{},key:"",limit:5,...e}}geocode(e,o,t){const i=this._getProximity(t),l={q:e,limit:this.options.limit,key:this.options.key,...i,...this.options.geocodingQueryParams};this._makeRequest(l,r=>{const c=this._processResults(r);o.call(t,c)})}reverse(e,o,t,i){this.geocode(e,t,i)}_getProximity(e){const o={};if(e&&e._map&&e._map.getCenter()){const t=e._map.getCenter();o.proximity=t.lat+","+t.lng}return o}_processResults(e){const o=[];for(let t=e.results.length-1;t>=0;t--)o[t]={name:e.results[t].formatted,center:new n.LatLng(e.results[t].geometry.lat,e.results[t].geometry.lng)},e.results[t].bounds&&(o[t].bounds=new n.LatLngBounds([e.results[t].bounds.southwest.lat,e.results[t].bounds.southwest.lng],[e.results[t].bounds.northeast.lat,e.results[t].bounds.northeast.lng])),this.options.resultExtension&&this._addResultExtensions(o[t],e.results[t]);return o}_addResultExtensions(e,o){const t=this.options.resultExtension,i=Object.keys(t);for(let l=i.length-1;l>=0;l--){const r=i[l];let c=o;const g=t[r].split(".");for(let d=0;d<g.length;d++){const C=g[d];if(c[C])c=c[C];else{c=void 0;break}}e[r]=c}}_makeRequest(e,o){O(e).then(t=>{o(t)})}}class h extends n.Control{constructor(e={}){super(e),this.options={showResultIcons:!1,collapsed:!0,expand:"click",position:"topright",placeholder:"Search...",errorMessage:"Nothing found.",key:"",onResultClick:void 0,addResultToMap:!0,limit:5,...e},this._callbackId=0,this.options.geocoder||(this.options.geocoder=new p(this.options))}onAdd(e){const o="leaflet-control-opencage-geocoding",t=n.DomUtil.create("div",o),i=n.DomUtil.create("div","leaflet-control-opencage-geocoding-icon",t),l=n.DomUtil.create("form",o+"-form",t);this._form=l,this._map=e,this._container=t;const r=n.DomUtil.create("input");return this._input=r,r.type="text",r.placeholder=this.options.placeholder,r.addEventListener("keydown",this._keydown,this),this._errorElement=document.createElement("div"),this._errorElement.className=o+"-form-no-error",this._errorElement.innerHTML=this.options.errorMessage,this._alts=n.DomUtil.create("ul",o+"-alternatives leaflet-control-opencage-geocoding-alternatives-minimized"),l.appendChild(r),l.appendChild(this._errorElement),t.appendChild(this._alts),l.addEventListener("submit",this._geocode,this),this.options.collapsed?this.options.expand==="click"?i.addEventListener("click",c=>{c.button===0&&c.detail!==2&&this._toggle()},this):(i.addEventListener("mouseover",this._expand,this),i.addEventListener("mouseout",this._collapse,this),this._map.on("movestart",this._collapse,this)):this._expand(),n.DomEvent.disableClickPropagation(t),t}_geocodeResult(e){if(n.DomUtil.removeClass(this._container,"leaflet-control-opencage-geocoding-spinner"),e.length===1)this._geocodeResultSelected(e[0]);else if(e.length>0){this._alts.innerHTML="",this._results=e,n.DomUtil.removeClass(this._alts,"leaflet-control-opencage-geocoding-alternatives-minimized");for(let o=0;o<e.length;o++)this._alts.appendChild(this._createAlt(e[o],o))}else n.DomUtil.addClass(this._errorElement,"leaflet-control-opencage-geocoding-error")}markGeocode(e){return e.bounds?this._map.fitBounds(e.bounds):this._map.panTo(e.center),this._geocodeMarker&&this._map.removeLayer(this._geocodeMarker),this._geocodeMarker=new n.Marker(e.center).bindPopup(e.name).addTo(this._map).openPopup(),this}_geocode(e){return n.DomEvent.preventDefault(e),n.DomUtil.addClass(this._container,"leaflet-control-opencage-geocoding-spinner"),this._clearResults(),this.options.geocoder.geocode(this._input.value,this._geocodeResult,this),!1}_geocodeResultSelected(e){this.options.collapsed?this._collapse():this._clearResults(),this.options.onResultClick&&typeof this.options.onResultClick=="function"&&this.options.onResultClick(e),this.options.addResultToMap&&this.markGeocode(e)}_toggle(){this._container.className.indexOf("leaflet-control-opencage-geocoding-expanded")>=0?this._collapse():this._expand()}_expand(){n.DomUtil.addClass(this._container,"leaflet-control-opencage-geocoding-expanded"),this._input.select()}_collapse(){this._container.className=this._container.className.replace(" leaflet-control-opencage-geocoding-expanded",""),n.DomUtil.addClass(this._alts,"leaflet-control-opencage-geocoding-alternatives-minimized"),n.DomUtil.removeClass(this._errorElement,"leaflet-control-opencage-geocoding-error")}_clearResults(){n.DomUtil.addClass(this._alts,"leaflet-control-opencage-geocoding-alternatives-minimized"),this._selection=null,n.DomUtil.removeClass(this._errorElement,"leaflet-control-opencage-geocoding-error")}_createAlt(e,o){const t=document.createElement("li");return t.innerHTML='<a href="#" data-result-index="'+o+'">'+(this.options.showResultIcons&&e.icon?'<img src="'+e.icon+'"/>':"")+e.name+"</a>",t.addEventListener("click",()=>{this._geocodeResultSelected(e)},this),t}_keydown(e){const o=t=>{this._selection&&(n.DomUtil.removeClass(this._selection.firstChild,"leaflet-control-opencage-geocoding-selected"),this._selection=this._selection[t>0?"nextSibling":"previousSibling"]),this._selection||(this._selection=this._alts[t>0?"firstChild":"lastChild"]),this._selection&&n.DomUtil.addClass(this._selection.firstChild,"leaflet-control-opencage-geocoding-selected")};switch(e.keyCode){case 38:o(-1),n.DomEvent.preventDefault(e);break;case 40:o(1),n.DomEvent.preventDefault(e);break;case 13:if(this._selection){const t=parseInt(this._selection.firstChild.getAttribute("data-result-index"),10);this._geocodeResultSelected(this._results[t]),this._clearResults(),n.DomEvent.preventDefault(e)}break}return!0}}const S=h,y=s=>new h(s);h.Geocoder=p,h.geocoder=s=>new p(s),Object.assign(L.Control,{OpenCageGeocoding:h,openCageGeocoding:y}),a.OpenCageGeocoder=p,a.OpenCageGeocoding=S,a.default=h,a.openCageGeocoding=y,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
