/**
 * OpenCage Data Geocoding Control v2.1.0-alpha.1 - 2025-10-06
 * Copyright (c) 2025, OpenCage GmbH 
 * support@opencagedata.com 
 * https://opencagedata.com 
 * 
 * Licensed under the BSD license. 
 * Demo: https://opencagedata.com 
 * Source: git@github.com:opencagedata/leaflet-opencage-geocoding.git 
 */
(function(a,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("leaflet")):typeof define=="function"&&define.amd?define(["exports","leaflet"],o):(a=typeof globalThis<"u"?globalThis:a||self,o(a["leaflet-control-opencage-geocoding"]={},a.L))})(this,(function(a,o){"use strict";class p{constructor(e={}){this.options={serviceUrl:"https://api.opencagedata.com/geocode/v1/json/",geocodingQueryParams:{},reverseQueryParams:{},key:"",limit:5,...e}}geocode(e,s,t){const l=this._getProximity(t),i={q:e,limit:this.options.limit,key:this.options.key,...l,...this.options.geocodingQueryParams};this._makeRequest(this.options.serviceUrl,i,n=>{const r=this._processResults(n);s.call(t,r)})}reverse(e,s,t,l){this.geocode(e,t,l)}_getProximity(e){const s={};if(e&&e._map&&e._map.getCenter()){const t=e._map.getCenter();s.proximity=t.lat+","+t.lng}return s}_processResults(e){const s=[];for(let t=e.results.length-1;t>=0;t--)s[t]={name:e.results[t].formatted,center:o.latLng(e.results[t].geometry.lat,e.results[t].geometry.lng)},e.results[t].bounds&&(s[t].bounds=o.latLngBounds([e.results[t].bounds.southwest.lat,e.results[t].bounds.southwest.lng],[e.results[t].bounds.northeast.lat,e.results[t].bounds.northeast.lng])),this.options.resultExtension&&this._addResultExtensions(s[t],e.results[t]);return s}_addResultExtensions(e,s){const t=this.options.resultExtension,l=Object.keys(t);for(let i=l.length-1;i>=0;i--){const n=l[i];let r=s;const d=t[n].split(".");for(let g=0;g<d.length;g++){const u=d[g];if(r[u])r=r[u];else{r=void 0;break}}e[n]=r}}_makeRequest(e,s,t){return f(e,s,t,this,"jsonp")}}let _=0;function f(c,e,s,t,l){const i="_ocd_geocoder_"+_++;e[l]=i,window[i]=function(r){s.call(t,r),delete window[i];const d=document.getElementById(i);d&&d.parentNode&&d.parentNode.removeChild(d)};const n=document.createElement("script");n.type="text/javascript",n.src=c+o.Util.getParamString(e),n.id=i,n.addEventListener("error",()=>{s.call(t,{results:[]}),delete window[i]}),n.addEventListener("abort",()=>{s.call(t,{results:[]}),delete window[i]}),document.getElementsByTagName("head")[0].appendChild(n)}class h extends o.Control{constructor(e={}){super(e),this.options={showResultIcons:!1,collapsed:!0,expand:"click",position:"topright",placeholder:"Search...",errorMessage:"Nothing found.",key:"",onResultClick:void 0,addResultToMap:!0,limit:5,...e},this._callbackId=0,this.options.geocoder||(this.options.geocoder=new p(this.options))}onAdd(e){const s="leaflet-control-opencage-geocoding",t=o.DomUtil.create("div",s),l=o.DomUtil.create("div","leaflet-control-opencage-geocoding-icon",t),i=o.DomUtil.create("form",s+"-form",t);this._form=i,this._map=e,this._container=t;const n=o.DomUtil.create("input");return this._input=n,n.type="text",n.placeholder=this.options.placeholder,o.DomEvent.addListener(n,"keydown",this._keydown,this),this._errorElement=document.createElement("div"),this._errorElement.className=s+"-form-no-error",this._errorElement.innerHTML=this.options.errorMessage,this._alts=o.DomUtil.create("ul",s+"-alternatives leaflet-control-opencage-geocoding-alternatives-minimized"),i.appendChild(n),i.appendChild(this._errorElement),t.appendChild(this._alts),o.DomEvent.addListener(i,"submit",this._geocode,this),this.options.collapsed?this.options.expand==="click"?o.DomEvent.addListener(l,"click",r=>{r.button===0&&r.detail!==2&&this._toggle()},this):(o.DomEvent.addListener(l,"mouseover",this._expand,this),o.DomEvent.addListener(l,"mouseout",this._collapse,this),this._map.on("movestart",this._collapse,this)):this._expand(),o.DomEvent.disableClickPropagation(t),t}_geocodeResult(e){if(o.DomUtil.removeClass(this._container,"leaflet-control-opencage-geocoding-spinner"),e.length===1)this._geocodeResultSelected(e[0]);else if(e.length>0){this._alts.innerHTML="",this._results=e,o.DomUtil.removeClass(this._alts,"leaflet-control-opencage-geocoding-alternatives-minimized");for(let s=0;s<e.length;s++)this._alts.appendChild(this._createAlt(e[s],s))}else o.DomUtil.addClass(this._errorElement,"leaflet-control-opencage-geocoding-error")}markGeocode(e){return e.bounds?this._map.fitBounds(e.bounds):this._map.panTo(e.center),this._geocodeMarker&&this._map.removeLayer(this._geocodeMarker),this._geocodeMarker=new o.Marker(e.center).bindPopup(e.name).addTo(this._map).openPopup(),this}_geocode(e){return o.DomEvent.preventDefault(e),o.DomUtil.addClass(this._container,"leaflet-control-opencage-geocoding-spinner"),this._clearResults(),this.options.geocoder.geocode(this._input.value,this._geocodeResult,this),!1}_geocodeResultSelected(e){this.options.collapsed?this._collapse():this._clearResults(),this.options.onResultClick&&typeof this.options.onResultClick=="function"&&this.options.onResultClick(e),this.options.addResultToMap&&this.markGeocode(e)}_toggle(){this._container.className.indexOf("leaflet-control-opencage-geocoding-expanded")>=0?this._collapse():this._expand()}_expand(){o.DomUtil.addClass(this._container,"leaflet-control-opencage-geocoding-expanded"),this._input.select()}_collapse(){this._container.className=this._container.className.replace(" leaflet-control-opencage-geocoding-expanded",""),o.DomUtil.addClass(this._alts,"leaflet-control-opencage-geocoding-alternatives-minimized"),o.DomUtil.removeClass(this._errorElement,"leaflet-control-opencage-geocoding-error")}_clearResults(){o.DomUtil.addClass(this._alts,"leaflet-control-opencage-geocoding-alternatives-minimized"),this._selection=null,o.DomUtil.removeClass(this._errorElement,"leaflet-control-opencage-geocoding-error")}_createAlt(e,s){const t=document.createElement("li");return t.innerHTML='<a href="#" data-result-index="'+s+'">'+(this.options.showResultIcons&&e.icon?'<img src="'+e.icon+'"/>':"")+e.name+"</a>",o.DomEvent.addListener(t,"click",()=>{this._geocodeResultSelected(e)},this),t}_keydown(e){const s=t=>{this._selection&&(o.DomUtil.removeClass(this._selection.firstChild,"leaflet-control-opencage-geocoding-selected"),this._selection=this._selection[t>0?"nextSibling":"previousSibling"]),this._selection||(this._selection=this._alts[t>0?"firstChild":"lastChild"]),this._selection&&o.DomUtil.addClass(this._selection.firstChild,"leaflet-control-opencage-geocoding-selected")};switch(e.keyCode){case 38:s(-1),o.DomEvent.preventDefault(e);break;case 40:s(1),o.DomEvent.preventDefault(e);break;case 13:if(this._selection){const t=parseInt(this._selection.firstChild.getAttribute("data-result-index"),10);this._geocodeResultSelected(this._results[t]),this._clearResults(),o.DomEvent.preventDefault(e)}break}return!0}}const m=c=>new h(c);h.Geocoder=p,h.geocoder=c=>new p(c),Object.assign(o.Control,{OpenCageGeocoding:h,openCageGeocoding:m}),a.OpenCageGeocoder=p,a.OpenCageGeocodingControl=h,a.default=h,a.openCageGeocoding=m,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
