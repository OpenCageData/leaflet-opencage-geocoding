/* 
 * OpenCage Data Geocoding Control v2.0.0 - 2022-02-01
 * Copyright (c) 2022, OpenCage GmbH 
 * support@opencagedata.com 
 * https://opencagedata.com 
 * 
 * Licensed under the BSD license. 
 * Demo: https://opencagedata.com 
 * Source: git@github.com:opencagedata/leaflet-opencage-geocoding.git 
 */
!function(e){var t;if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("undefined"!=typeof module)t=require("leaflet"),module.exports=e(t);else{if(void 0===window.L)throw"Leaflet must be loaded first";e(window.L)}}(function(h){"use strict";return h.Control.OpenCageGeocoding=h.Control.extend({options:{showResultIcons:!1,collapsed:!0,expand:"click",position:"topright",placeholder:"Search...",errorMessage:"Nothing found.",key:"",onResultClick:void 0,addResultToMap:!0,limit:5},_callbackId:0,initialize:function(e){h.Util.setOptions(this,e),this.options.geocoder||(this.options.geocoder=new h.Control.OpenCageGeocoding.Geocoder(this.options))},onAdd:function(e){var t="leaflet-control-opencage-geocoding",o=h.DomUtil.create("div",t),n=h.DomUtil.create("div","leaflet-control-opencage-geocoding-icon",o),i=this._form=h.DomUtil.create("form",t+"-form",o);return this._map=e,this._container=o,(e=this._input=h.DomUtil.create("input")).type="text",e.placeholder=this.options.placeholder,h.DomEvent.addListener(e,"keydown",this._keydown,this),this._errorElement=document.createElement("div"),this._errorElement.className=t+"-form-no-error",this._errorElement.innerHTML=this.options.errorMessage,this._alts=h.DomUtil.create("ul",t+"-alternatives leaflet-control-opencage-geocoding-alternatives-minimized"),i.appendChild(e),i.appendChild(this._errorElement),o.appendChild(this._alts),h.DomEvent.addListener(i,"submit",this._geocode,this),this.options.collapsed?"click"===this.options.expand?h.DomEvent.addListener(n,"click",function(e){0===e.button&&2!==e.detail&&this._toggle()},this):(h.DomEvent.addListener(n,"mouseover",this._expand,this),h.DomEvent.addListener(n,"mouseout",this._collapse,this),this._map.on("movestart",this._collapse,this)):this._expand(),h.DomEvent.disableClickPropagation(o),o},_geocodeResult:function(e){if(h.DomUtil.removeClass(this._container,"leaflet-control-opencage-geocoding-spinner"),1===e.length)this._geocodeResultSelected(e[0]);else if(0<e.length){this._alts.innerHTML="",this._results=e,h.DomUtil.removeClass(this._alts,"leaflet-control-opencage-geocoding-alternatives-minimized");for(var t=0;t<e.length;t++)this._alts.appendChild(this._createAlt(e[t],t))}else h.DomUtil.addClass(this._errorElement,"leaflet-control-opencage-geocoding-error")},markGeocode:function(e){return e.bounds?this._map.fitBounds(e.bounds):this._map.panTo(e.center),this._geocodeMarker&&this._map.removeLayer(this._geocodeMarker),this._geocodeMarker=new h.Marker(e.center).bindPopup(e.name).addTo(this._map).openPopup(),this},_geocode:function(e){return h.DomEvent.preventDefault(e),h.DomUtil.addClass(this._container,"leaflet-control-opencage-geocoding-spinner"),this._clearResults(),this.options.geocoder.geocode(this._input.value,this._geocodeResult,this),!1},_geocodeResultSelected:function(e){this.options.collapsed?this._collapse():this._clearResults(),this.options.onResultClick&&"function"==typeof this.options.onResultClick&&this.options.onResultClick(e),this.options.addResultToMap&&this.markGeocode(e)},_toggle:function(){0<=this._container.className.indexOf("leaflet-control-opencage-geocoding-expanded")?this._collapse():this._expand()},_expand:function(){h.DomUtil.addClass(this._container,"leaflet-control-opencage-geocoding-expanded"),this._input.select()},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-opencage-geocoding-expanded",""),h.DomUtil.addClass(this._alts,"leaflet-control-opencage-geocoding-alternatives-minimized"),h.DomUtil.removeClass(this._errorElement,"leaflet-control-opencage-geocoding-error")},_clearResults:function(){h.DomUtil.addClass(this._alts,"leaflet-control-opencage-geocoding-alternatives-minimized"),this._selection=null,h.DomUtil.removeClass(this._errorElement,"leaflet-control-opencage-geocoding-error")},_createAlt:function(e,t){var o=document.createElement("li");return o.innerHTML='<a href="#" data-result-index="'+t+'">'+(this.options.showResultIcons&&e.icon?'<img src="'+e.icon+'"/>':"")+e.name+"</a>",h.DomEvent.addListener(o,"click",function(){this._geocodeResultSelected(e)},this),o},_keydown:function(e){function t(e){n._selection&&(h.DomUtil.removeClass(n._selection.firstChild,"leaflet-control-opencage-geocoding-selected"),n._selection=n._selection[0<e?"nextSibling":"previousSibling"]),n._selection||(n._selection=n._alts[0<e?"firstChild":"lastChild"]),n._selection&&h.DomUtil.addClass(n._selection.firstChild,"leaflet-control-opencage-geocoding-selected")}var o,n=this;switch(e.keyCode){case 38:t(-1),h.DomEvent.preventDefault(e);break;case 40:t(1),h.DomEvent.preventDefault(e);break;case 13:this._selection&&(o=parseInt(this._selection.firstChild.getAttribute("data-result-index"),10),this._geocodeResultSelected(this._results[o]),this._clearResults(),h.DomEvent.preventDefault(e))}return!0}}),h.Control.openCageGeocoding=function(e,t){return new h.Control.OpenCageGeocoding(e,t)},h.Control.OpenCageGeocoding.callbackId=0,h.Control.OpenCageGeocoding.jsonp=function(e,t,o,n,i){var s="_ocd_geocoder_"+h.Control.OpenCageGeocoding.callbackId++,i=(t[i||"callback"]=s,window[s]=h.Util.bind(o,n),document.createElement("script"));i.type="text/javascript",i.src=e+h.Util.getParamString(t),i.id=s,i.addEventListener("error",function(){o({results:[]})}),i.addEventListener("abort",function(){o({results:[]})}),document.getElementsByTagName("head")[0].appendChild(i)},h.Control.OpenCageGeocoding.Geocoder=h.Class.extend({options:{serviceUrl:"https://api.opencagedata.com/geocode/v1/",geocodingQueryParams:{},reverseQueryParams:{},key:"",limit:5},initialize:function(e){h.Util.setOptions(this,e)},geocode:function(e,p,g){var t,o={};g&&g._map&&g._map.getCenter()&&(t=g._map.getCenter(),o.proximity=t.lat+","+t.lng),h.Control.OpenCageGeocoding.jsonp(this.options.serviceUrl+"json/",h.extend({q:e,limit:this.options.limit,key:this.options.key},o,this.options.geocodingQueryParams),function(e){for(var t=[],o=e.results.length-1;0<=o;o--)if(t[o]={name:e.results[o].formatted,center:h.latLng(e.results[o].geometry.lat,e.results[o].geometry.lng)},e.results[o].bounds&&(t[o].bounds=h.latLngBounds([e.results[o].bounds.southwest.lat,e.results[o].bounds.southwest.lng],[e.results[o].bounds.northeast.lat,e.results[o].bounds.northeast.lng])),this.options.resultExtension)for(var n=this.options.resultExtension,i=Object.keys(n),s=i.length-1;0<=s;s--){for(var l=i[s],r=e.results[o],a=n[l].split("."),c=0;c<a.length;c++)var d=a[c],r=r[d]||void 0;t[o][l]=r}p.call(g,t)},this,"jsonp")},reverse:function(e,t,o,n){this.geocode(e,o,n)}}),h.Control.OpenCageGeocoding.geocoder=function(e){return new h.Control.OpenCageGeocoding.Geocoder(e)},h.Control.OpenCageGeocoding});