/* 
 * OpenCage Data Search Control v1.4.1 - 2021-04-27
 * Copyright (c) 2021, OpenCage GmbH 
 * support@opencagedata.com 
 * https://opencagedata.com 
 * 
 * Licensed under the BSD license. 
 * Demo: https://opencagedata.com 
 * Source: git@github.com:opencagedata/leaflet-opencage-search.git 
 */

!function(e){var t;if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("undefined"!=typeof module)t=require("leaflet"),module.exports=e(t);else{if(void 0===window.L)throw"Leaflet must be loaded first";e(window.L)}}(function(u){"use strict";return u.Control.OpenCageSearch=u.Control.extend({options:{showResultIcons:!1,collapsed:!0,expand:"click",position:"topright",placeholder:"Search...",errorMessage:"Nothing found.",key:"",onResultClick:void 0,addResultToMap:!0,limit:5},_callbackId:0,initialize:function(e){u.Util.setOptions(this,e),this.options.geocoder||(this.options.geocoder=new u.Control.OpenCageSearch.Geocoder(this.options))},onAdd:function(e){var t="leaflet-control-ocd-search",o=u.DomUtil.create("div",t),s=this._clearResultInput=u.DomUtil.create("span","leaflet-control-ocd-search-clear-result hide",o),i=u.DomUtil.create("div","leaflet-control-ocd-search-icon",o),n=this._form=u.DomUtil.create("form",t+"-form",o);return this._map=e,this._container=o,(e=this._input=u.DomUtil.create("input")).type="text",e.placeholder=this.options.placeholder,u.DomEvent.addListener(e,"keydown",this._keydown,this),s.innerHTML="X",s.href="#",u.DomEvent.addListener(s,"click",this._clearResults,this),this._errorElement=document.createElement("div"),this._errorElement.className=t+"-form-no-error",this._errorElement.innerHTML=this.options.errorMessage,this._alts=u.DomUtil.create("ul",t+"-alternatives leaflet-control-ocd-search-alternatives-minimized"),n.appendChild(e),n.appendChild(this._errorElement),o.appendChild(this._alts),u.DomEvent.addListener(n,"submit",this._geocode,this),u.DomEvent.addListener(i,"click",this._geocode,this),this.options.collapsed?"click"===this.options.expand?u.DomEvent.addListener(i,"click",function(e){0===e.button&&2!==e.detail&&this._toggle()},this):(u.DomEvent.addListener(i,"mouseover",this._expand,this),u.DomEvent.addListener(i,"mouseout",this._collapse,this),this._map.on("movestart",this._collapse,this)):this._expand(),u.DomEvent.disableClickPropagation(o),o},_geocodeResult:function(e){if(u.DomUtil.removeClass(this._container,"leaflet-control-ocd-search-spinner"),1===e.length)this._geocodeResultSelected(e[0]);else if(0<e.length){u.DomUtil.removeClass(this._clearResultInput,"hide"),this._alts.innerHTML="",this._results=e,u.DomUtil.removeClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized");for(var t=0;t<e.length;t++)this._alts.appendChild(this._createAlt(e[t],t));"topleft"==this.options.position||"topright"==this.options.position||"bottomleft"!=this.options.position&&"bottomright"!=this.options.position||this._container.insertBefore(this._alts,this._container.firstElementChild)}else u.DomUtil.addClass(this._errorElement,"leaflet-control-ocd-search-error")},markGeocode:function(e){return e.bounds?this._map.fitBounds(e.bounds):this._map.panTo(e.center),this._geocodeMarker&&this._map.removeLayer(this._geocodeMarker),this._geocodeMarker=new u.Marker(e.center).bindPopup(e.name).addTo(this._map).openPopup(),this},_geocode:function(e){return u.DomEvent.preventDefault(e),u.DomUtil.addClass(this._container,"leaflet-control-ocd-search-spinner"),this._clearResults(),this.options.geocoder.geocode(this._input.value,this._geocodeResult,this),!1},_geocodeResultSelected:function(e){this.options.collapsed?this._collapse():this._clearResults(),this.options.onResultClick&&"function"==typeof this.options.onResultClick&&this.options.onResultClick(e),this.options.addResultToMap&&this.markGeocode(e)},_toggle:function(){0<=this._container.className.indexOf("leaflet-control-ocd-search-expanded")?this._collapse():this._expand()},_expand:function(){u.DomUtil.addClass(this._container,"leaflet-control-ocd-search-expanded"),this._input.select()},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-ocd-search-expanded",""),u.DomUtil.addClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized"),u.DomUtil.removeClass(this._errorElement,"leaflet-control-ocd-search-error")},_clearResults:function(){u.DomUtil.addClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized"),this._selection=null,u.DomUtil.removeClass(this._errorElement,"leaflet-control-ocd-search-error"),u.DomUtil.addClass(this._clearResultInput,"hide")},_createAlt:function(e,t){var o=document.createElement("li");return o.innerHTML='<a href="#" data-result-index="'+t+'">'+(this.options.showResultIcons&&e.icon?'<img src="'+e.icon+'"/>':"")+e.name+"</a>",u.DomEvent.addListener(o,"click",function(){this._geocodeResultSelected(e)},this),o},_keydown:function(e){function t(e){s._selection&&(u.DomUtil.removeClass(s._selection.firstChild,"leaflet-control-ocd-search-selected"),s._selection=s._selection[0<e?"nextSibling":"previousSibling"]),s._selection||(s._selection=s._alts[0<e?"firstChild":"lastChild"]),s._selection&&u.DomUtil.addClass(s._selection.firstChild,"leaflet-control-ocd-search-selected")}var o,s=this;switch(e.keyCode){case 38:t(-1),u.DomEvent.preventDefault(e);break;case 40:t(1),u.DomEvent.preventDefault(e);break;case 13:this._selection&&(o=parseInt(this._selection.firstChild.getAttribute("data-result-index"),10),this._geocodeResultSelected(this._results[o]),this._clearResults(),u.DomEvent.preventDefault(e))}return!0}}),u.Control.openCageSearch=function(e,t){return new u.Control.OpenCageSearch(e,t)},u.Control.OpenCageSearch.callbackId=0,u.Control.OpenCageSearch.jsonp=function(e,t,o,s,i){var n="_ocd_geocoder_"+u.Control.OpenCageSearch.callbackId++;t[i||"callback"]=n,window[n]=u.Util.bind(o,s);s=document.createElement("script");s.type="text/javascript",s.src=e+u.Util.getParamString(t),s.id=n,s.addEventListener("error",function(){o({results:[]})}),s.addEventListener("abort",function(){o({results:[]})}),document.getElementsByTagName("head")[0].appendChild(s)},u.Control.OpenCageSearch.Geocoder=u.Class.extend({options:{serviceUrl:"https://api.opencagedata.com/geocode/v1/",geocodingQueryParams:{},reverseQueryParams:{},key:"",limit:5},initialize:function(e){u.Util.setOptions(this,e)},geocode:function(e,h,p){var t,o={};p&&p._map&&p._map.getCenter()&&(t=p._map.getCenter(),o.proximity=t.lat+","+t.lng),u.Control.OpenCageSearch.jsonp(this.options.serviceUrl+"json/",u.extend({q:e,limit:this.options.limit,key:this.options.key},o,this.options.geocodingQueryParams),function(e){for(var t=[],o=e.results.length-1;0<=o;o--)if(t[o]={name:e.results[o].formatted,center:u.latLng(e.results[o].geometry.lat,e.results[o].geometry.lng)},e.results[o].bounds&&(t[o].bounds=u.latLngBounds([e.results[o].bounds.southwest.lat,e.results[o].bounds.southwest.lng],[e.results[o].bounds.northeast.lat,e.results[o].bounds.northeast.lng])),this.options.resultExtension)for(var s=this.options.resultExtension,i=Object.keys(s),n=i.length-1;0<=n;n--){for(var l=i[n],r=e.results[o],a=s[l].split("."),c=0;c<a.length;c++)var d=a[c],r=r[d]||void 0;t[o][l]=r}h.call(p,t)},this,"jsonp")},reverse:function(e,t,o,s){this.geocode(e,o,s)}}),u.Control.OpenCageSearch.geocoder=function(e){return new u.Control.OpenCageSearch.Geocoder(e)},u.Control.OpenCageSearch});